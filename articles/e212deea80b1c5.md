---
title: "ã€Supabaseã€‘\"TypeError: Key for the ES256 algorithm ...\"ã®è§£æ±ºæ–¹æ³•"
emoji: "ğŸ”§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Supabase"]
published: true
---

## Supabase Edge Functions ãŒãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ãªããªã£ãŸ

å°‘ã—æ‰‹ã“ãšã£ãŸã®ã§ãƒ¡ãƒ¢ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚

ã„ã¤ã‚‚é€šã‚Šã€ `supabase start` ã§ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’ç«‹ã¡ä¸Šã’ã¦ã€ Edge Functions ã‚’å‹•ã‹ãã†ã¨ã—ãŸã¨ã“ã‚ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

```sh
TypeError: Key for the ES256 algorithm must be of type CryptoKey. Received an instance of Uint8Array
```

ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è¦‹ã‚‹ã¨ã€ã©ã†ã‚„ã‚‰ Edge Functions ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ `jose` ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèµ·å› ã®ã‚¨ãƒ©ãƒ¼ã®ã‚ˆã†ã§ã™ã€‚

èª¿ã¹ã¦ã¿ãŸã¨ã“ã‚ã€ä»¥ä¸‹ã®è¨˜äº‹ãŒãƒ’ãƒƒãƒˆã—ã¾ã—ãŸã€‚

https://medium.com/@sinancsoysal/fixing-jwserror-jwsinvalidsignature-in-self-hosted-supabase-edge-functions-d4799caf4c9f

Supabase ã®éå¯¾ç§° JWT ã¸ã®ç§»è¡Œã«ä¼´ã†ç ´å£Šçš„å¤‰æ›´ãŒåŸå› ã®ã‚ˆã†ã§ã™ã€‚

## è§£æ±ºæ–¹æ³•

è§£æ±ºæ–¹æ³•ã¯ 2 ã¤ã‚ã‚Šã¾ã™ã€‚

1. Supabase CLI ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ `2.69.0` ã«ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹
2. ã‚«ã‚¹ã‚¿ãƒ  JWT æ¤œè¨¼ãƒãƒ³ãƒ‰ãƒ©ã‚’å®Ÿè£…ã™ã‚‹

### 1. Supabase CLI ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ `2.69.0` ã«ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹

1 ã¤ç›®ã®æ–¹æ³•ã¯ç°¡å˜ã§ã™ãŒã€ Supabase CLI ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒå‡ºæ¥ãªããªã‚‹ãŸã‚ã€ã¨ã‚Šã‚ãˆãšå‹•ã‹ã™ãŸã‚ã®å¿œæ€¥å‡¦ç½®ã§ã™ã€‚

1. ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® Supabase CLI ã‚’ä½¿ç”¨ã—ã¦ Supabase ã‚’é–‹å§‹ã™ã‚‹

```sh
npx supabase@2.69.0 start
```

2. Supabase CLI ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ Edge Functions ã‚’ç«‹ã¡ä¸Šã’ã‚‹

```sh
npx supabase@2.69.0 functions serve
```

### 2. ã‚«ã‚¹ã‚¿ãƒ  JWT æ¤œè¨¼ãƒãƒ³ãƒ‰ãƒ©ã‚’å®Ÿè£…ã™ã‚‹

2 ã¤ç›®ã®æ–¹æ³•ã¯ã€ Supabase CLI ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€å°‘ã—æ‰‹é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚

1. ã‚«ã‚¹ã‚¿ãƒ  JWT æ¤œè¨¼ãƒãƒ³ãƒ‰ãƒ©ã‚’å®Ÿè£…ã™ã‚‹

```typescript:supabase/functions/_shared/jwt/default.ts
// Default supabase JWT verification
// Use this template to validate tokens issued by Supabase default auth
import * as jose from "jsr:@panva/jose@6";

const SUPABASE_JWT_ISSUER = Deno.env.get("SB_JWT_ISSUER") ??
  Deno.env.get("SUPABASE_URL") + "/auth/v1";

const SUPABASE_JWT_KEYS = jose.createRemoteJWKSet(
  new URL(Deno.env.get("SUPABASE_URL")! + "/auth/v1/.well-known/jwks.json"),
);

function getAuthToken(req: Request) {
  const authHeader = req.headers.get("authorization");
  if (!authHeader) {
    throw new Error("Missing authorization header");
  }
  const [bearer, token] = authHeader.split(" ");
  if (bearer !== "Bearer") {
    throw new Error(`Auth header is not 'Bearer {token}'`);
  }
  return token;
}

function verifySupabaseJWT(jwt: string) {
  return jose.jwtVerify(jwt, SUPABASE_JWT_KEYS, {
    issuer: SUPABASE_JWT_ISSUER,
  });
}

// Validates authorization header
export async function AuthMiddleware(
  req: Request,
  next: (req: Request) => Promise<Response>,
) {
  if (req.method === "OPTIONS") return await next(req);
  try {
    const token = getAuthToken(req);
    const isValidJWT = await verifySupabaseJWT(token);
    if (isValidJWT) return await next(req);
    return Response.json({ msg: "Invalid JWT" }, {
      status: 401,
    });
  } catch (e) {
    return Response.json({ msg: e?.toString() }, {
      status: 401,
    });
  }
}
```

2. ã‚«ã‚¹ã‚¿ãƒ  JWT æ¤œè¨¼ãƒãƒ³ãƒ‰ãƒ©ã‚’ Edge Functions ã§ä½¿ç”¨ã™ã‚‹

```diff typescript
+ import { AuthMiddleware } from "../_shared/jwt/default.ts";

interface reqPayload {
  name: string;
}
Deno.serve((r) =>
+ AuthMiddleware(r, async (req) => {
    const { name }: reqPayload = await req.json();
    const data = {
      message: `Hello ${name} from foo!`,
    };
    return Response.json(data);
+ });
);
```

3. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® JWT æ¤œè¨¼ãƒãƒ³ãƒ‰ãƒ©ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹

```diff toml:supabase/config.toml
...

[functions.hello]
enabled = true
- verify_jwt = true
+ verify_jwt = false
import_map = "./functions/hello/deno.json"
# Uncomment to specify a custom file path to the entrypoint.
# Supported file extensions are: .ts, .js, .mjs, .jsx, .tsx
entrypoint = "./functions/hello/index.ts"
# Specifies static files to be bundled with the function. Supports glob patterns.
# For example, if you want to serve static HTML pages in your function:
# static_files = [ "./functions/hello/*.html" ]
```

4. ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹

```env:supabase/functions/.env
SB_PUBLISHABLE_KEY=sb_publishable_<key>
SB_JWT_ISSUER=<url>/auth/v1
```

ç’°å¢ƒå¤‰æ•°ã®å€¤ã¯ã€ `supabase status` ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã¾ã™ã€‚

5. Edge Functions ã‚’ç«‹ã¡ä¸Šã’ã‚‹

```sh
supabase functions serve
```

## ãŠã‚ã‚Šã«

åŒã˜å•é¡Œã«ç›´é¢ã—ã¦ã„ã‚‹æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
